<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Matemáticas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>MATH TEST</h1>

    <div id="resultado"></div>

    <div id="pregunta"></div>

    <div id="opciones"></div>

    <div id="contenedorStart">
        <button id="start">¡Comenzar el test!</button>
    </div>

    <div id="navegacion">
        <button id="anterior"> Volver a la pregunta anterior</button>
        <button id="siguiente">Siguiente pregunta</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {

            const url = "https://opentdb.com/api.php?amount=10&category=19&difficulty=medium&type=multiple&encode=url3986";

            let preguntas = [];
            
            let indice = 0;

            let respuestas = [];

            let puntuacion = 0;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    preguntas = data.results.map(p => new Pregunta (
                        decodeText(p.question),
                        mezclarPreguntas([...p.incorrect_answers.map(op => decodeText(op)), decodeText(p.correct_answer)]),
                        decodeText(p.correct_answer)
                    ));
                    
                    siguientePregunta();
                });
            
            // Recibe un texto codificado en URL, lo decodifica y devuelve el texto normal
            function decodeText(text) {
                return decodeURIComponent(text);
            }

            // Baraja aleatoriamente los elementos del array de respuestas
            function mezclarPreguntas(array) {

                // El método .sort recibe una función de comparación (Math.random()) que determina el orden del array.
                // Math.random() genera un número aleatorio entre 0 y 1. Si restamos 0.5, obtenemos valores entre -0.5 y 0.5.
                // Al devolver un número positivo o negativo aleatoriamente, .sort() mezcla los elementos del array de manera
                // aleatoria
                return array.sort(() => Math.random() - 0.5);
            }

            class Pregunta {
                constructor(texto, opciones, correcta) {
                    this.texto = texto;
                    this.opciones = opciones;
                    this.correcta = correcta;
                }
            }

            function mostrarPregunta(i) {
                const pregunta = preguntas[i];

                // Mostrar la pregunta
                const contenedorPregunta = document.getElementById("pregunta");
                contenedorPregunta.innerHTML = `<h2>${pregunta.texto}</h2>`;

                // Mostrar las opciones
                const contenedorOpciones = document.getElementById("opciones");
                contenedorOpciones.innerHTML = pregunta.opciones
                    .map(op => {
                        let seleccionado = respuestas[i] === op ? "selected" : "";
                        return `<button class="opcion ${seleccionado}">${op}</button>`;
                    })
                    .join("");

                // Añadir eventos a los botones
                document.querySelectorAll(".opcion").forEach(boton => {
                    boton.addEventListener("click", () => {
                        respuestas[i] = boton.textContent; // Se guarda la respuesta
                        document.querySelectorAll(".opcion").forEach(b => b.classList.remove("selected"));
                        boton.classList.add("selected");
                    });
                });

                // Actualizar los botones de navegación
                document.getElementById("anterior").disable = (i === 0);
                document.getElementById("siguiente").textContent = (i === preguntas.length -1) ? "Acabar test" : "Siguiente pregunta"
            }

            document.getElementById("start").addEventListener("click", () => {
                document.getElementById("pregunta").style.display = "block";

                document.getElementById("start").style.display = "none"; // Se oculta el botón una vez has hecho clic
                document.getElementById("navegacion").style.display = "block"; // Entonces se muestran los botones de navegación
                mostrarPregunta(indice); // Muestra la primera pregunta
            });

            document.getElementById("siguiente").addEventListener("click", () => {
                if (indice < preguntas.length - 1) {
                    indice++;
                    mostrarPregunta(indice);
                } else {

                    // Calcular puntuación
                    puntuacion = preguntas.reduce((acc, p, idx) => {
                        return acc + (respuestas[idx] === p.correcta ? 1 : 0);
                    }, 0);

                    document.getElementById("resultado").innerHTML = `<h2>🎉 ¡Enhorabuena! ¡Has acabado el test!</h2><br>
                                                                      <p>Tu puntuación es de ${puntuacion}</p>`;

                    document.getElementById("pregunta").innerHTML = "";
                    document.getElementById("pregunta").style.display = "none";

                    document.getElementById("opciones").innerHTML = "";

                    document.getElementById("anterior").style.display = "none";
                    document.getElementById("siguiente").style.display = "none";
                }
            });

            document.getElementById("anterior").addEventListener("click", () => {
                if (indice > 0) {
                    indice--;
                    mostrarPregunta(indice)
                }
            });
        });
    </script>
</body>
</html>